name: build
run-name: Windows x86_64 build

on:
  workflow_dispatch:
  repository_dispatch:
    types: [zapret_update]
  schedule:
    - cron: '0 */6 * * *'  # Проверка каждые 6 часов

jobs:
  check-updates:
    runs-on: ubuntu-latest
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      latest_commit: ${{ steps.check.outputs.latest_commit }}
    steps:
      - name: Check for updates
        id: check
        run: |
          # Получаем последний коммит из bol-van/zapret
          LATEST_COMMIT=$(curl -s https://api.github.com/repos/bol-van/zapret/commits/master | jq -r .sha)
          
          # Получаем последний сохраненный коммит
          LAST_BUILT_COMMIT=$(curl -s https://api.github.com/repos/${{ github.repository }}/contents/files/last_commit.txt || echo "")
          
          if [ "$LATEST_COMMIT" != "$LAST_BUILT_COMMIT" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "latest_commit=$LATEST_COMMIT" >> $GITHUB_OUTPUT
          else
            echo "should_build=false" >> $GITHUB_OUTPUT
          fi

  build-windows:
    needs: check-updates
    if: needs.check-updates.outputs.should_build == 'true'
    name: Windows x86_64
    runs-on: windows-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          repository: bol-van/zapret
          path: zapret

      - name: Set up MinGW
        uses: msys2/setup-msys2@v2
        with:
          msystem: MINGW64
          install: mingw-w64-x86_64-toolchain

      - name: Build ip2net, mdig
        shell: msys2 {0}
        run: |
          export CFLAGS="-DZAPRET_GH_VER=${{ github.ref_name }} -DZAPRET_GH_HASH=${{ github.sha }}"
          mkdir -p output
          cd zapret
          mingw32-make -C ip2net win
          mingw32-make -C mdig win
          cp -a {ip2net/ip2net,mdig/mdig}.exe ../output

      - name: Restore psmisc from cache
        id: cache-restore-psmisc
        uses: actions/cache/restore@v4
        with:
          path: ${{ github.workspace }}/psmisc
          key: psmisc-x86_64

      - name: Set up Cygwin
        env:
          PACKAGES: ${{ steps.cache-restore-psmisc.outputs.cache-hit != 'true' && 'cygport gettext-devel libiconv-devel libncurses-devel' || null }}
        uses: cygwin/cygwin-install-action@v4
        with:
          platform: x86_64
          site: http://ctm.crouchingtigerhiddenfruitbat.org/pub/cygwin/circa/64bit/2024/01/30/231215
          check-sig: false
          packages: >-
            gcc-core
            make
            zlib-devel
            zip
            unzip
            wget
            ${{ env.PACKAGES }}

      - name: Build psmisc
        if: steps.cache-restore-psmisc.outputs.cache-hit != 'true'
        env:
          URL: https://mirrors.kernel.org/sourceware/cygwin/x86_64/release/psmisc
        shell: C:\cygwin\bin\bash.exe -eo pipefail '{0}'
        run: >-
          export MAKEFLAGS=-j$(nproc) &&
          mkdir -p psmisc && cd psmisc &&
          wget -qO- ${URL} | grep -Po 'href=\"\Kpsmisc-(\d+\.)+\d+.+src\.tar\.xz(?=\")' | xargs -I{} wget -O- ${URL}/{} | tar -xJ &&
          cd psmisc-*.src &&
          echo CYGCONF_ARGS+=\" --disable-dependency-tracking --disable-nls\" >> psmisc.cygport &&
          cygport psmisc.cygport prep compile install

      - name: Save psmisc to cache
        if: steps.cache-restore-psmisc.outputs.cache-hit != 'true'
        uses: actions/cache/save@v4
        with:
          path: ${{ github.workspace }}/psmisc
          key: psmisc-x86_64

      - name: Build winws
        shell: C:\cygwin\bin\bash.exe -eo pipefail '{0}'
        run: >-
          export MAKEFLAGS=-j$(nproc) &&
          export CFLAGS="-DZAPRET_GH_VER=${{ github.ref_name }} -DZAPRET_GH_HASH=${{ github.sha }}" &&
          cd zapret &&
          make -C nfq cygwin &&
          cp -a nfq/winws.exe ../output

      - name: Create zip
        shell: C:\cygwin\bin\bash.exe -e '{0}'
        run: >-
          cp -a -t output psmisc/psmisc-*.src/psmisc-*/inst/usr/bin/killall.exe /usr/bin/cygwin1.dll &&
          wget -O WinDivert.zip https://github.com/basil00/WinDivert/releases/download/v2.2.2/WinDivert-2.2.2-A.zip &&
          unzip -j WinDivert.zip "*/x64/WinDivert.dll" "*/x64/WinDivert64.sys" -d output &&
          zip zapret-win-x86_64.zip -j output/*

      - name: Checkout main repository
        uses: actions/checkout@v4
        with:
          path: main-repo
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Update files
        shell: bash
        run: |
          # Копируем собранный winws в files
          mkdir -p main-repo/files
          cp zapret/binaries/my/winws main-repo/files/
          
          # Сохраняем последний коммит
          echo "${{ needs.check-updates.outputs.latest_commit }}" > main-repo/files/last_commit.txt
          
          cd main-repo
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add files/
          git commit -m "Update winws files from zapret repository"
          git push

      - name: Upload artifacts
        uses: actions/upload-artifact@v4
        with:
          name: zapret-win-x86_64
          path: zapret-*.zip
          if-no-files-found: error
